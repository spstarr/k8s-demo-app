name: Security OpenGrep

on:
  workflow_call:

permissions:
  contents: read
  actions: read
  security-events: write
  packages: read

concurrency:
  group: ${{ github.workflow }}--${{ github.ref }}
  cancel-in-progress: true

jobs:
  opengrep:
    name: OpenGrep Scanning
    runs-on: ubuntu-latest
    if: (github.actor != 'dependabot[bot]')
    permissions:
      contents: read
      actions: read
      security-events: write
      packages: read

    strategy:
      fail-fast: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OpenGrep 1.9.0
        run: |
           wget -q -O /tmp/opengrep.sig.base64 https://github.com/opengrep/opengrep/releases/download/v1.9.0/opengrep_manylinux_x86.sig
           wget -q -O /tmp/opengrep.pem.base64 https://github.com/opengrep/opengrep/releases/download/v1.9.0/opengrep_manylinux_x86.cert
           wget -q -O /tmp/opengrep https://github.com/opengrep/opengrep/releases/download/v1.9.0/opengrep_manylinux_x86

      - name: Download OpenGrep Rules and clean development files
        run: |
           git clone https://github.com/opengrep/opengrep-rules /tmp/opengrep-rules
           (cd /tmp/opengrep-rules; rm -rfv {stats,scripts,template.yaml,*.schm,.pre-commit-config.yaml,*.md,.gitignore,.codemapignore,.semgrepignore,.github,Makefile,Pipfile*})

      - name: Base64 Decode Cert and PEM and verify executable trust
        run: |
           base64 -d /tmp/opengrep.sig.base64 > /tmp/opengrep.sig
           base64 -d /tmp/opengrep.pem.base64 > /tmp/opengrep.pem
           openssl x509 -in /tmp/opengrep.pem -pubkey -noout > /tmp/opengrep.pub.pem
           openssl dgst -sha256 -verify /tmp/opengrep.pub.pem -signature /tmp/opengrep.sig /tmp/opengrep
        continue-on-error: false

      - name: Perform OpenGrep Analysis
        run: |
           chmod -v 0755 /tmp/opengrep
           /tmp/opengrep scan -f /tmp/opengrep-rules/ --verbose --sarif --config auto . > opengrep-results.sarif

      - name: Upload SARIF file results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: opengrep-results.sarif
          category: opengrep
